<!-- Archivo: src/main/resources/templates/Carta.html -->

<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Menú | Amor por el Café</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <link rel='stylesheet' type='text/css' media='screen' href="css/Carta.css"> 
</head>

<body>
<header class=" text-white ">
    <nav class="navbar navbar-expand-sm navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Amor por el Café</a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup"
                    aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

        <div class="collapse navbar-collapse justify-content-between" id="navbarNavAltMarkup">
          <div class="navbar-nav">
                    <a class="nav-link text-white" th:href="@{/Inicio.html}">Inicio</a> 
                    <a class="nav-link text-white" th:href="@{/Carta.html}">Pedidos</a> 
                    <a class="nav-link text-white" th:href="@{/cart}">Carrito</a> 
                    <a  class="nav-link text-white"th:href="@{/reserva/form}">Reservar Mesa</a> 
                    <a class="nav-link text-white" th:href="@{/SobreNosotros.html}">Sobre Nosotros</a>
                    <a class="nav-link text-white" th:href="@{/Eventos.html}">Eventos</a> 
          </div>

                <form th:action="@{/Carta.html}" method="get" class="d-flex">
                    <input type="text" name="searchTerm" class="form-control me-2" placeholder="Buscar..." aria-label="Buscar" th:value="${param.searchTerm}">
                    <button class="btn btn-outline-light" type="submit">Buscar</button>
                </form>

<div class="d-flex gap-3">
                        <a th:href="@{/usuario/ingresar}" class="btn btn-light">Iniciar Sesión</a>
                        <a th:href="@{/usuario/nuevousuario}" class="btn btn-light">Registrar</a>
</div>
            </div>
        </div>
    </nav>
</header>

    <div class="container-fluid">
        <!-- BEBIDAS -->
        <div class="row g-4 p-5 m-1">
            <h4>Bebidas</h4>
            <div th:each="item : ${productos}" 
                 th:if="${item != null and item.categoria != null and (item.categoria.nombre == 'Bebidas Calientes' or item.categoria.nombre == 'Bebidas Frías')}" 
                 class="col-lg-4 col-md-6">
                <div class="card"
                     data-bs-toggle="modal"
                     data-bs-target="#productModal"
                     th:data-bs-product-id="${item.id}" 
                     th:data-bs-product-nombre="${item.nombre}"  
                     th:data-bs-product-precio="${item.precio}"> 
                     <!-- AÑADIMOS UNA COMPROBACIÓN ADICIONAL PARA urlImagen -->
                     <img th:src="${item.urlImagen != null ? item.urlImagen : '/images/placeholder.png'}" 
                          class="card-img-top" 
                          th:alt="${item.nombre}">
                     <div class="card-body">
                         <h3 class="card-title" th:text="${item.nombre}">Nombre Artículo</h3>
                         <p class="card-text" th:text="${item.descripcion}">Descripción Artículo</p>
                         <p class="card-text">
                             Precio: <span th:text="'S/ ' + ${#numbers.formatDecimal(item.precio, 1, 2)}">S/ 0.00</span>
                         </p>
                         <a href="#" class="btn btn-dark">Comprar</a> 
                     </div>
                 </div>
            </div>
             <!-- Mostrar mensaje si no hay productos en esta categoría -->
            <div th:if="${#lists.isEmpty(productos.?[categoria != null and (categoria.nombre == 'Bebidas Calientes' or categoria.nombre == 'Bebidas Frías')])}">
                <p>No hay productos disponibles en esta categoría.</p>
            </div>
        </div>

        <!-- POSTRES -->
        <div class="row g-4 p-5 m-1">
            <h4>Postres</h4>
            <div th:each="item : ${productos}" 
                 th:if="${item != null and item.categoria != null and item.categoria.nombre == 'Postres'}" 
                 class="col-lg-4 col-md-6">
                <div class="card"
                     data-bs-toggle="modal"
                     data-bs-target="#productModal"
                     th:data-bs-product-id="${item.id}" 
                     th:data-bs-product-nombre="${item.nombre}"  
                     th:data-bs-product-precio="${item.precio}"> 
                     <img th:src="${item.urlImagen != null ? item.urlImagen : '/images/placeholder.png'}" 
                          class="card-img-top" 
                          th:alt="${item.nombre}">
                     <div class="card-body">
                         <h3 class="card-title" th:text="${item.nombre}">Nombre Artículo</h3>
                         <p class="card-text" th:text="${item.descripcion}">Descripción Artículo</p>
                         <p class="card-text">
                             Precio: <span th:text="'S/ ' + ${#numbers.formatDecimal(item.precio, 1, 2)}">S/ 0.00</span>
                         </p>
                         <a href="#" class="btn btn-dark">Comprar</a> 
                     </div>
                 </div>
            </div>
            <div th:if="${#lists.isEmpty(productos.?[categoria != null and categoria.nombre == 'Postres'])}">
                <p>No hay productos disponibles en esta categoría.</p>
            </div>
        </div>

        <!-- PANADERÍA Y COMIDAS (Otras categorías) -->
        <div class="row g-4 p-5 m-1">
            <h4>Panadería y Comidas</h4>
            <div th:each="item : ${productos}" 
                 th:if="${item != null and item.categoria != null and (item.categoria.nombre == 'Panadería' or item.categoria.nombre == 'Comidas')}" 
                 class="col-lg-4 col-md-6">
                <div class="card"
                     data-bs-toggle="modal"
                     data-bs-target="#productModal"
                     th:data-bs-product-id="${item.id}" 
                     th:data-bs-product-nombre="${item.nombre}" 
                     th:data-bs-product-precio="${item.precio}"> 
                     <img th:src="${item.urlImagen != null ? item.urlImagen : '/images/placeholder.png'}" 
                          class="card-img-top" 
                          th:alt="${item.nombre}">
                     <div class="card-body">
                         <h3 class="card-title" th:text="${item.nombre}">Nombre Artículo</h3>
                         <p class="card-text" th:text="${item.descripcion}">Descripción Artículo</p>
                         <p class="card-text">
                             Precio: <span th:text="'S/ ' + ${#numbers.formatDecimal(item.precio, 1, 2)}">S/ 0.00</span>
                         </p>
                         <a href="#" class="btn btn-dark">Comprar</a> 
                     </div>
                 </div> 
            </div>
            <div th:if="${#lists.isEmpty(productos.?[categoria != null and (categoria.nombre == 'Panadería' or categoria.nombre == 'Comidas')])}">
                <p>No hay productos disponibles en esta categoría.</p>
            </div>
        </div>
    </div>

<footer>
    <h4>By Grupo 1 2025</h4>
    <a href="https://www.whatsapp.com/?lang=es_LA">WhatsApp</a>
    <a href="https://www.instagram.com/">Instagram</a>
</footer>

<!-- El modal y el script JavaScript se mantienen igual -->
<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="productModalLabel">Seleccionar Opciones</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <h4 id="modalProductName"></h4>
        <p>Precio Unitario: S/ <span id="modalProductPrice"></span></p>

        <div class="mb-3">
            <label class="form-label">Tamaño:</label><br>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="productSize" id="sizeSmall" value="Pequeño" checked>
                <label class="form-check-label" for="sizeSmall">Pequeño</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="productSize" id="sizeMedium" value="Mediano">
                <label class="form-check-label" for="sizeMedium">Mediano</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="productSize" id="sizeLarge" value="Grande">
                <label class="form-check-label" for="sizeLarge">Grande</label>
            </div>
        </div>

        <div class="mb-3">
            <label for="productQuantity" class="form-label">Cantidad:</label>
            <input type="number" class="form-control" id="productQuantity" value="1" min="1">
        </div>

        </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-dark" id="addToCartButton">Añadir al Carrito</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous"></script>
<script>
    var productModal = document.getElementById('productModal');
    productModal.addEventListener('show.bs.modal', function (event) {
      var button = event.relatedTarget;
      var productId = button.dataset.bsProductId;
      var productName = button.dataset.bsProductNombre;
      var productPrice = button.dataset.bsProductPrecio;

      var modalTitle = productModal.querySelector('.modal-title');
      var modalProductName = productModal.querySelector('#modalProductName');
      var modalProductPrice = productModal.querySelector('#modalProductPrice');
      var addToCartButton = productModal.querySelector('#addToCartButton');

      modalTitle.textContent = 'Opciones para ' + productName;
      modalProductName.textContent = productName;
      modalProductPrice.textContent = parseFloat(productPrice).toFixed(2);

      addToCartButton.dataset.productId = productId;
      addToCartButton.dataset.productPrice = productPrice;
      addToCartButton.dataset.productName = productName;

      document.getElementById('productQuantity').value = 1;
      document.getElementById('sizeSmall').checked = true;
    });

    var addToCartButton = document.getElementById('addToCartButton');

    addToCartButton.addEventListener('click', function() {
    var productId = this.dataset.productId;
    var productName = this.dataset.productName;
    var productPrice = this.dataset.productPrice;

    var selectedSizeElement = document.querySelector('input[name="productSize"]:checked');
    var selectedSize = selectedSizeElement ? selectedSizeElement.value : null;

    var quantityElement = document.getElementById('productQuantity');
    var selectedQuantity = parseInt(quantityElement.value);

    if (!productId || !selectedQuantity || selectedQuantity <= 0) {
        alert('Por favor, selecciona un producto y una cantidad válida.');
        return;
    }

    console.log('Producto Seleccionado:', {
           id: productId,
           nombre: productName,
           precio: productPrice, 
           tamaño: selectedSize,
           cantidad: selectedQuantity
         });
         
    var data = new URLSearchParams();
    data.append('productId', productId);
    data.append('size', selectedSize);
    data.append('quantity', selectedQuantity);

    fetch('/cart/add', {
        method: 'POST',
        body: data
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => { throw new Error('Error en la respuesta del servidor: ' + response.status + ' ' + response.statusText + ' - ' + text) });
        }
        return response.text();
    })
    .then(result => {
        console.log('Éxito:', result);
        alert('¡Producto "' + productName + '" añadido al carrito!');
        var modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
        if (modal) {
            modal.hide();
        }
    })
    .catch(error => {
        console.error('Error al añadir al carrito:', error);
        alert('Hubo un error al añadir el producto al carrito.');
    });
    
});
</script>
</body>
</html>